name: Build magic.RIDE

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

env:
  PLUGIN_NAME: magic.RIDE
  VERSION: 1.2.0

jobs:
  build-macos:
    runs-on: macos-14
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.1'
    
    - name: Import Code Signing Certificates
      env:
        APP_CERTIFICATE_BASE64: ${{ secrets.MACOS_APP_CERTIFICATE }}
        INSTALLER_CERTIFICATE_BASE64: ${{ secrets.MACOS_INSTALLER_CERTIFICATE }}
        P12_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        KEYCHAIN_PASSWORD: ${{ github.run_id }}
      run: |
        APP_CERTIFICATE_PATH=$RUNNER_TEMP/app_certificate.p12
        INSTALLER_CERTIFICATE_PATH=$RUNNER_TEMP/installer_certificate.p12
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

        echo -n "$APP_CERTIFICATE_BASE64" | base64 --decode -o $APP_CERTIFICATE_PATH
        echo -n "$INSTALLER_CERTIFICATE_BASE64" | base64 --decode -o $INSTALLER_CERTIFICATE_PATH

        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        security import $APP_CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security import $INSTALLER_CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH

        security list-keychain -d user -s $KEYCHAIN_PATH
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"
    
    - name: Build
      run: cmake --build build --config Release -j$(sysctl -n hw.ncpu)
    
    - name: Sign AU, VST3, & AAX Plugins
      env:
        TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        SIGN_ID="Developer ID Application: MATTHEW STEVEN ERNST ($TEAM_ID)"
        
        codesign --deep --force --verify --verbose \
          --sign "$SIGN_ID" --options runtime \
          build/VocalRider_artefacts/Release/AU/magic.RIDE.component
        
        codesign --deep --force --verify --verbose \
          --sign "$SIGN_ID" --options runtime \
          build/VocalRider_artefacts/Release/VST3/magic.RIDE.vst3
        
        if [ -d "build/VocalRider_artefacts/Release/AAX/magic.RIDE.aaxplugin" ]; then
          codesign --deep --force --verify --verbose \
            --sign "$SIGN_ID" --options runtime \
            build/VocalRider_artefacts/Release/AAX/magic.RIDE.aaxplugin
          echo "AAX Apple-codesigned (wraptool will re-sign later if available)."
        fi
        
        codesign -dv --verbose=4 build/VocalRider_artefacts/Release/AU/magic.RIDE.component
        codesign -dv --verbose=4 build/VocalRider_artefacts/Release/VST3/magic.RIDE.vst3
    
    - name: Download Eden SDK (macOS)
      env:
        GH_TOKEN: ${{ secrets.BUILD_TOOLS_TOKEN }}
      run: |
        gh release download eden-sdk-mac-v5.10.4 \
          --repo mbmattie/build-tools \
          --pattern "*.dmg" \
          --dir $RUNNER_TEMP/eden
      continue-on-error: true
    
    - name: Install Eden SDK & iLok License Manager (macOS)
      run: |
        # Install iLok License Manager
        curl -o $RUNNER_TEMP/LicenseSupportInstallerMac.zip \
          https://installers.ilok.com/iloklicensemanager/LicenseSupportInstallerMac.zip
        unzip $RUNNER_TEMP/LicenseSupportInstallerMac.zip -d $RUNNER_TEMP/ilok
        hdiutil attach $RUNNER_TEMP/ilok/LicenseSupportInstallerMac*.dmg
        ilokVol=$(ls /Volumes | grep "License")
        sudo installer -pkg "/Volumes/$ilokVol/License Support.pkg" -target LocalSystem
        hdiutil detach "/Volumes/$ilokVol" || true
        
        # Install Eden SDK
        DMG_FILE=$(ls $RUNNER_TEMP/eden/*.dmg 2>/dev/null | head -1)
        if [ -n "$DMG_FILE" ]; then
          echo "Installing Eden SDK from $DMG_FILE"
          hdiutil attach "$DMG_FILE"
          edenVol=$(ls /Volumes | grep -i eden | head -1)
          if [ -n "$edenVol" ]; then
            PKG_FILE=$(find "/Volumes/$edenVol" -name "*.pkg" -maxdepth 1 | head -1)
            if [ -n "$PKG_FILE" ]; then
              sudo installer -pkg "$PKG_FILE" -target LocalSystem
              echo "Eden SDK installed."
            else
              echo "No .pkg found in DMG. Listing contents:"
              ls "/Volumes/$edenVol"
            fi
            hdiutil detach "/Volumes/$edenVol" || true
          fi
        else
          echo "Eden SDK DMG not found. AAX signing will be skipped."
        fi
      continue-on-error: true
    
    - name: Sign macOS AAX (PACE Cloud Signing)
      env:
        ILOK_USERNAME: ${{ secrets.ILOK_USERNAME }}
        ILOK_PASSWORD: ${{ secrets.ILOK_PASSWORD }}
        PACE_CUSTOMER_NUMBER: ${{ secrets.PACE_CUSTOMER_NUMBER }}
        TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        WRAPTOOL="/Applications/PACEAntiPiracy/Eden/Fusion/Versions/5/bin/wraptool"
        AAX_IN="build/VocalRider_artefacts/Release/AAX/magic.RIDE.aaxplugin"
        AAX_OUT="build/VocalRider_artefacts/Release/AAX/magic.RIDE_signed.aaxplugin"
        
        if [ ! -f "$WRAPTOOL" ]; then
          echo "wraptool not found. Skipping AAX signing."
          exit 0
        fi
        
        if [ -z "$ILOK_USERNAME" ] || [ -z "$ILOK_PASSWORD" ]; then
          echo "iLok credentials not configured. Skipping AAX signing."
          exit 0
        fi
        
        echo "Opening iLok cloud session..."
        iloktool cloud --open --account "$ILOK_USERNAME" --password "$ILOK_PASSWORD" -v || {
          echo "WARNING: Failed to open iLok cloud session. Skipping AAX signing."
          exit 0
        }
        
        echo "Signing AAX plugin..."
        $WRAPTOOL sign --verbose \
          --account "$ILOK_USERNAME" \
          --signid "Developer ID Application: MATTHEW STEVEN ERNST ($TEAM_ID)" \
          --customernumber "$PACE_CUSTOMER_NUMBER" \
          --customername "MBM Audio" \
          --productname "magic.RIDE" \
          --allowsigningservice \
          --dsig1-compat off \
          --in "$AAX_IN" \
          --out "$AAX_OUT"
        
        if [ $? -eq 0 ]; then
          $WRAPTOOL verify --verbose --in "$AAX_OUT"
          rm -rf "$AAX_IN"
          ditto "$AAX_OUT" "$AAX_IN"
          rm -rf "$AAX_OUT"
          echo "AAX plugin signed successfully!"
        else
          echo "WARNING: AAX signing failed."
        fi
        
        echo "Closing iLok cloud session..."
        iloktool cloud --close -v || true
      continue-on-error: true
    
    - name: Build Installer
      run: |
        cd installer
        chmod +x build_installer.sh
        ./build_installer.sh
    
    - name: Sign Installer
      env:
        TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        productsign --sign "Developer ID Installer: MATTHEW STEVEN ERNST ($TEAM_ID)" \
          installer/output/magic.RIDE-${{ env.VERSION }}-Installer.pkg \
          installer/output/magic.RIDE-${{ env.VERSION }}-Installer-signed.pkg
        
        mv installer/output/magic.RIDE-${{ env.VERSION }}-Installer-signed.pkg \
           installer/output/magic.RIDE-${{ env.VERSION }}-Installer.pkg
    
    - name: Notarize Installer
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        SUBMIT_OUT=$(xcrun notarytool submit installer/output/magic.RIDE-${{ env.VERSION }}-Installer.pkg \
          --apple-id "$APPLE_ID" \
          --team-id "$TEAM_ID" \
          --password "$APPLE_APP_PASSWORD" \
          --wait 2>&1) || true
        
        echo "$SUBMIT_OUT"
        
        SUBMISSION_ID=$(echo "$SUBMIT_OUT" | grep "id:" | head -1 | awk '{print $2}')
        STATUS=$(echo "$SUBMIT_OUT" | grep "status:" | tail -1 | awk '{print $2}')
        
        if [ "$STATUS" = "Invalid" ] || [ "$STATUS" = "Rejected" ]; then
          echo "=== Notarization FAILED. Fetching detailed log... ==="
          xcrun notarytool log "$SUBMISSION_ID" \
            --apple-id "$APPLE_ID" \
            --team-id "$TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            notarization-log.json || true
          cat notarization-log.json 2>/dev/null || true
          exit 1
        fi
        
        xcrun stapler staple installer/output/magic.RIDE-${{ env.VERSION }}-Installer.pkg
        xcrun stapler validate installer/output/magic.RIDE-${{ env.VERSION }}-Installer.pkg
    
    - name: Upload macOS Installer (Signed & Notarized)
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PLUGIN_NAME }}-${{ env.VERSION }}-macOS-Installer
        path: installer/output/*.pkg
    
    - name: Upload macOS AU (Signed)
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PLUGIN_NAME }}-${{ env.VERSION }}-macOS-AU
        path: build/VocalRider_artefacts/Release/AU/*.component
    
    - name: Upload macOS VST3 (Signed)
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PLUGIN_NAME }}-${{ env.VERSION }}-macOS-VST3
        path: build/VocalRider_artefacts/Release/VST3/*.vst3
    
    - name: Upload macOS AAX
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PLUGIN_NAME }}-${{ env.VERSION }}-macOS-AAX
        path: build/VocalRider_artefacts/Release/AAX/*.aaxplugin
    
    - name: Cleanup Keychain
      if: always()
      run: |
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      run: cmake --build build --config Release --parallel
    
    - name: List build artifacts
      run: |
        echo "Checking build output..."
        dir build\VocalRider_artefacts\Release\VST3\ /s
      shell: cmd
    
    - name: Install iLok License Manager (Windows)
      run: |
        $zipUrl = "https://installers.ilok.com/iloklicensemanager/LicenseSupportInstallerWin.zip"
        $zipPath = "$env:RUNNER_TEMP\LicenseSupportInstallerWin.zip"
        $extractPath = "$env:RUNNER_TEMP\ilok"
        
        Write-Host "Downloading iLok License Manager..."
        Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath
        Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
        
        $installer = Get-ChildItem -Path $extractPath -Filter "*.exe" -Recurse | Select-Object -First 1
        if ($installer) {
          Write-Host "Installing iLok License Manager: $($installer.FullName)"
          Start-Process -FilePath $installer.FullName -ArgumentList "/S" -Wait -NoNewWindow
          Write-Host "iLok License Manager installed."
        } else {
          Write-Host "WARNING: iLok installer not found in zip."
        }
      shell: pwsh
      continue-on-error: true
    
    - name: Download Eden SDK
      env:
        GH_TOKEN: ${{ secrets.BUILD_TOOLS_TOKEN }}
      run: |
        gh release download eden-sdk-v5.10.4 `
          --repo mbmattie/build-tools `
          --pattern "*.exe" `
          --dir $env:RUNNER_TEMP\eden
      shell: pwsh
      continue-on-error: true
    
    - name: Install Eden SDK
      run: |
        $installer = Get-ChildItem -Path "$env:RUNNER_TEMP\eden" -Filter "*.exe" | Select-Object -First 1
        if ($installer) {
          Write-Host "Installing Eden SDK: $($installer.FullName)"
          Start-Process -FilePath $installer.FullName -ArgumentList "/S" -Wait -NoNewWindow
          Write-Host "Eden SDK installed."
        } else {
          Write-Host "Eden SDK installer not found. AAX signing will be skipped."
        }
      shell: pwsh
      continue-on-error: true
    
    - name: Sign Windows AAX (PACE Cloud Signing)
      env:
        ILOK_USERNAME: ${{ secrets.ILOK_USERNAME }}
        ILOK_PASSWORD: ${{ secrets.ILOK_PASSWORD }}
        PACE_CUSTOMER_NUMBER: ${{ secrets.PACE_CUSTOMER_NUMBER }}
      run: |
        $AAX_IN = "build\VocalRider_artefacts\Release\AAX\magic.RIDE.aaxplugin"
        
        if (-not $env:ILOK_USERNAME -or -not $env:ILOK_PASSWORD) {
          Write-Host "iLok credentials not configured. Skipping AAX signing."
          exit 0
        }
        
        if (-not (Test-Path $AAX_IN)) {
          Write-Host "AAX plugin not found. Skipping AAX signing."
          exit 0
        }
        
        # Find wraptool and iloktool
        $wraptool = Get-ChildItem -Path "C:\Program Files" -Filter "wraptool.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        $iloktool = Get-ChildItem -Path "C:\Program Files" -Filter "iloktool.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        
        if (-not $wraptool) {
          Write-Host "wraptool not found. Skipping AAX signing."
          exit 0
        }
        
        Write-Host "Found wraptool: $($wraptool.FullName)"
        
        # Open iLok cloud session
        if ($iloktool) {
          Write-Host "Opening iLok cloud session..."
          & $iloktool.FullName cloud --open --account $env:ILOK_USERNAME --password $env:ILOK_PASSWORD -v
          if ($LASTEXITCODE -ne 0) {
            Write-Host "WARNING: Failed to open iLok cloud session. Skipping AAX signing."
            exit 0
          }
        }
        
        # Sign the AAX plugin
        Write-Host "Signing AAX plugin..."
        & $wraptool.FullName sign --verbose `
          --account $env:ILOK_USERNAME `
          --customernumber $env:PACE_CUSTOMER_NUMBER `
          --customername "MBM Audio" `
          --productname "magic.RIDE" `
          --allowsigningservice `
          --dsig1-compat off `
          --in $AAX_IN `
          --out "${AAX_IN}_signed"
        
        if ($LASTEXITCODE -eq 0) {
          Remove-Item -Recurse -Force $AAX_IN
          Rename-Item "${AAX_IN}_signed" $AAX_IN
          Write-Host "AAX plugin signed successfully!"
          
          & $wraptool.FullName verify --verbose --in $AAX_IN
        } else {
          Write-Host "WARNING: AAX signing failed."
        }
        
        # Close iLok cloud session
        if ($iloktool) {
          Write-Host "Closing iLok cloud session..."
          & $iloktool.FullName cloud --close -v
        }
      shell: pwsh
      continue-on-error: true
    
    - name: Create installer output directory
      run: mkdir -p installer\output
      shell: pwsh
    
    - name: Build Windows Installer
      run: |
        & "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe" installer\windows\magic.RIDE.iss
      shell: pwsh
    
    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PLUGIN_NAME }}-${{ env.VERSION }}-Windows-Installer
        path: installer/output/*-Windows-Setup.exe
    
    - name: Upload Windows VST3
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PLUGIN_NAME }}-${{ env.VERSION }}-Windows-VST3
        path: build/VocalRider_artefacts/Release/VST3/*.vst3
    
    - name: Upload Windows Standalone
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PLUGIN_NAME }}-${{ env.VERSION }}-Windows-Standalone
        path: build/VocalRider_artefacts/Release/Standalone/*.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Display artifacts
      run: ls -R artifacts
    
    - name: Create ZIP archives
      run: |
        cd artifacts
        for dir in */; do
          zip -r "${dir%/}.zip" "$dir"
        done
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*.zip
        draft: true
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
