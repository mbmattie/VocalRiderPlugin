name: Test AAX Wrap

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Build run ID to download AAX from (leave empty for latest)'
        required: false
      platform:
        description: 'Platform to test'
        required: true
        default: 'both'
        type: choice
        options:
          - windows
          - macos
          - both

env:
  PLUGIN_NAME: magic.RIDE
  VERSION: 1.2.0

jobs:
  wrap-windows:
    if: inputs.platform == 'windows' || inputs.platform == 'both'
    runs-on: windows-latest
    steps:
    - name: Download unsigned Windows AAX
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh
      run: |
        $repo = "${{ github.repository }}"
        $runId = "${{ inputs.run_id }}"
        if (-not $runId) {
          $runs = gh run list --repo $repo --workflow build.yml --status success --limit 1 --json databaseId | ConvertFrom-Json
          $runId = $runs[0].databaseId
        }
        Write-Host "Downloading AAX from build run: $runId"
        New-Item -ItemType Directory -Path aax-input -Force | Out-Null

        $downloaded = $false
        gh run download $runId --repo $repo --name "magic.RIDE-1.2.0-Windows-AAX-Unsigned" --dir aax-input 2>$null
        if ($LASTEXITCODE -eq 0) { $downloaded = $true }
        if (-not $downloaded) {
          gh run download $runId --repo $repo --name "magic.RIDE-1.2.0-Windows-AAX" --dir aax-input
          if ($LASTEXITCODE -ne 0) { Write-Error "Failed to download AAX artifact"; exit 1 }
        }

        Write-Host "=== Downloaded AAX contents ==="
        Get-ChildItem aax-input -Recurse | ForEach-Object {
          Write-Host "  $($_.FullName) ($([math]::Round($_.Length/1KB))KB)"
        }

    - name: Install Eden SDK
      env:
        GH_TOKEN: ${{ secrets.BUILD_TOOLS_TOKEN }}
      shell: pwsh
      run: |
        $sdkDir = "$env:RUNNER_TEMP\eden"
        New-Item -ItemType Directory -Path $sdkDir -Force | Out-Null

        gh release download eden-sdk-v5.10.4 `
          --repo mbmattie/build-tools `
          --pattern "EdenSDKLiteInstallerWin64.zip" `
          --dir $sdkDir

        # 7-Zip is much faster than Expand-Archive for large files
        & 7z x "$sdkDir\EdenSDKLiteInstallerWin64.zip" -o"$sdkDir\extracted" -y

        $installer = Get-ChildItem "$sdkDir" -Filter "Eden*.exe" -Recurse | Select-Object -First 1
        $issFile = Get-ChildItem $installer.Directory -Filter "*.iss" | Where-Object { $_.Name -notlike "*Uninstall*" } | Select-Object -First 1

        Write-Host "Installer: $($installer.FullName)"
        Write-Host "Response file: $($issFile.FullName)"

        $installArgs = @('/S', '/v"/qn"')
        if ($issFile) { $installArgs += "/f1`"$($issFile.FullName)`"" }

        $proc = Start-Process -FilePath $installer.FullName -ArgumentList $installArgs -PassThru
        Write-Host "Waiting 90s for install..."
        Start-Sleep -Seconds 90

        if (-not $proc.HasExited) {
          Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 5
        }

        $wraptool = Get-ChildItem "C:\Program Files (x86)","C:\Program Files" -Filter "wraptool.exe" -Recurse -ErrorAction SilentlyContinue
        $iloktool = Get-ChildItem "C:\Program Files (x86)","C:\Program Files" -Filter "iloktool.exe" -Recurse -ErrorAction SilentlyContinue
        foreach ($t in $wraptool) { Write-Host "Found: $($t.FullName)" }
        foreach ($t in $iloktool) { Write-Host "Found: $($t.FullName)" }

    - name: Create self-signed code signing cert & wrap AAX
      env:
        ILOK_USERNAME: ${{ secrets.ILOK_USERNAME }}
        ILOK_PASSWORD: ${{ secrets.ILOK_PASSWORD }}
        PACE_CUSTOMER_NUMBER: ${{ secrets.PACE_CUSTOMER_NUMBER }}
      shell: pwsh
      timeout-minutes: 5
      run: |
        # Force legacy CSP (CNG keys cause signtool to hang)
        $cert = New-SelfSignedCertificate `
          -Type CodeSigningCert `
          -Subject "CN=MBM Audio Test, O=MBM Audio" `
          -KeyAlgorithm RSA -KeyLength 2048 -HashAlgorithm SHA256 `
          -CertStoreLocation Cert:\CurrentUser\My `
          -KeySpec Signature `
          -Provider "Microsoft Enhanced RSA and AES Cryptographic Provider" `
          -NotAfter (Get-Date).AddDays(1)
        $thumbprint = $cert.Thumbprint
        Write-Host "Cert thumbprint: $thumbprint"
        Write-Host "Cert provider: $((Get-Item Cert:\CurrentUser\My\$thumbprint).PrivateKey.CspKeyContainerInfo.ProviderName)"

        # Also export to PFX as backup
        $pfxPath = "$env:RUNNER_TEMP\test-codesign.pfx"
        $securePass = ConvertTo-SecureString "TempPass!" -Force -AsPlainText
        Export-PfxCertificate -Cert $cert -FilePath $pfxPath -Password $securePass | Out-Null

        # Find tools
        $WRAPTOOL = (Get-ChildItem "C:\Program Files (x86)","C:\Program Files" -Filter "wraptool.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
        $ILOKTOOL = (Get-ChildItem "C:\Program Files (x86)","C:\Program Files" -Filter "iloktool.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1).FullName

        if (-not $WRAPTOOL) { Write-Error "wraptool.exe not found"; exit 1 }
        if (-not $ILOKTOOL) { Write-Error "iloktool.exe not found"; exit 1 }

        $fusionHome = [System.Environment]::GetEnvironmentVariable("PACE_FUSION_HOME", "Machine")
        if (-not $fusionHome) { $fusionHome = Split-Path $WRAPTOOL -Parent }
        $env:PACE_FUSION_HOME = $fusionHome

        $AAX_IN = (Get-ChildItem "aax-input" -Filter "*.aaxplugin" -Recurse -Directory | Select-Object -First 1).FullName
        $AAX_OUT = "$env:RUNNER_TEMP\magic.RIDE.aaxplugin"

        Write-Host "PACE_FUSION_HOME: $fusionHome"
        Write-Host "wraptool: $WRAPTOOL"
        Write-Host "Input:    $AAX_IN"
        Write-Host "Output:   $AAX_OUT"

        # First, verify signtool works independently
        $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits" -Filter "signtool.exe" -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.FullName -like "*x64*" } | Select-Object -Last 1
        if ($signtool) {
          Write-Host "`n=== Testing signtool directly ==="
          Write-Host "signtool: $($signtool.FullName)"
          $testDll = Get-ChildItem $AAX_IN -Filter "*.aaxplugin" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $testDll) { $testDll = Get-ChildItem $AAX_IN -Filter "*.dll" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1 }
          if ($testDll) {
            Write-Host "Test signing: $($testDll.FullName)"
            & $signtool.FullName sign /sha1 $thumbprint /fd sha256 $testDll.FullName
            Write-Host "signtool exit code: $LASTEXITCODE"
          }
        } else {
          Write-Host "WARNING: signtool.exe not found on runner"
        }

        Write-Host "`n=== Opening iLok Cloud session ==="
        & $ILOKTOOL cloud --open --account $env:ILOK_USERNAME --password $env:ILOK_PASSWORD -v

        Write-Host "`n=== Signing AAX with wraptool ==="
        & $WRAPTOOL sign --verbose `
          --account $env:ILOK_USERNAME `
          --customernumber $env:PACE_CUSTOMER_NUMBER `
          --customername "MBM Audio" `
          --productname "magic.RIDE" `
          --allowsigningservice `
          --signid $thumbprint `
          --timestampurl "http://timestamp.digicert.com" `
          --extrasigningoptions "/fd sha256 /td sha256 /v" `
          --in $AAX_IN `
          --out $AAX_OUT

        if ($LASTEXITCODE -ne 0) { Write-Error "wraptool sign failed (exit code $LASTEXITCODE)"; exit 1 }

        Write-Host "`n=== Verifying signed AAX ==="
        & $WRAPTOOL verify --verbose --in $AAX_OUT

        & $ILOKTOOL cloud --close -v
        Write-Host "`nWindows AAX wrapped successfully"

    - name: Upload wrapped Windows AAX
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PLUGIN_NAME }}-${{ env.VERSION }}-Windows-AAX-Signed
        path: ${{ runner.temp }}/magic.RIDE.aaxplugin

  wrap-macos:
    if: inputs.platform == 'macos' || inputs.platform == 'both'
    runs-on: macos-14
    steps:
    - name: Download unsigned macOS AAX
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        REPO="${{ github.repository }}"
        RUN_ID="${{ inputs.run_id }}"
        if [ -z "$RUN_ID" ]; then
          RUN_ID=$(gh run list --repo "$REPO" --workflow build.yml --status success --limit 1 --json databaseId --jq '.[0].databaseId')
        fi
        echo "Downloading AAX from build run: $RUN_ID"
        mkdir -p aax-input

        gh run download "$RUN_ID" --repo "$REPO" --name "magic.RIDE-1.2.0-macOS-AAX-Unsigned" --dir aax-input 2>/dev/null \
          || gh run download "$RUN_ID" --repo "$REPO" --name "magic.RIDE-1.2.0-macOS-AAX" --dir aax-input

        echo "=== Downloaded AAX contents ==="
        find aax-input -type f | head -20

    - name: Import Code Signing Certificate
      env:
        APP_CERTIFICATE_BASE64: ${{ secrets.MACOS_APP_CERTIFICATE }}
        P12_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        KEYCHAIN_PASSWORD: ${{ github.run_id }}
      run: |
        CERT_PATH=$RUNNER_TEMP/app_certificate.p12
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

        echo -n "$APP_CERTIFICATE_BASE64" | base64 --decode -o $CERT_PATH

        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security import $CERT_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

    - name: Download & Install Eden SDK
      env:
        GH_TOKEN: ${{ secrets.BUILD_TOOLS_TOKEN }}
      run: |
        gh release download eden-sdk-mac-v5.10.4 \
          --repo mbmattie/build-tools \
          --pattern "*.dmg" \
          --dir "$RUNNER_TEMP"

        DMG=$(ls "$RUNNER_TEMP"/*.dmg | head -1)
        MOUNT_DIR=$(hdiutil attach "$DMG" -nobrowse | tail -1 | awk -F'\t' '{print $NF}')
        echo "Mounted at: $MOUNT_DIR"

        PKG=$(find "$MOUNT_DIR" -name "*.pkg" -maxdepth 2 | head -1)
        if [ -n "$PKG" ]; then
          sudo installer -pkg "$PKG" -target /
        else
          echo "ERROR: No .pkg found in DMG"
          find "$MOUNT_DIR" -maxdepth 3
          exit 1
        fi
        hdiutil detach "$MOUNT_DIR" || true

    - name: Wrap macOS AAX
      env:
        ILOK_USERNAME: ${{ secrets.ILOK_USERNAME }}
        ILOK_PASSWORD: ${{ secrets.ILOK_PASSWORD }}
        PACE_CUSTOMER_NUMBER: ${{ secrets.PACE_CUSTOMER_NUMBER }}
        TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        WRAPTOOL="/Applications/PACEAntiPiracy/Eden/Fusion/Versions/5/bin/wraptool"
        ILOKTOOL=$(which iloktool 2>/dev/null || find /Applications/PACEAntiPiracy /usr/local -name "iloktool" -type f 2>/dev/null | head -1)

        if [ ! -f "$WRAPTOOL" ]; then echo "ERROR: wraptool not found"; exit 1; fi
        if [ -z "$ILOKTOOL" ]; then echo "ERROR: iloktool not found"; exit 1; fi

        security default-keychain -s $RUNNER_TEMP/app-signing.keychain-db

        AAX_IN=$(find aax-input -name "*.aaxplugin" -type d | head -1)
        AAX_OUT="$RUNNER_TEMP/magic.RIDE.aaxplugin"

        echo "Input:  $AAX_IN"
        echo "Output: $AAX_OUT"

        echo "=== Opening iLok Cloud session ==="
        "$ILOKTOOL" cloud --open --account "$ILOK_USERNAME" --password "$ILOK_PASSWORD" -v

        echo "=== Signing AAX with wraptool ==="
        "$WRAPTOOL" sign --verbose \
          --account "$ILOK_USERNAME" \
          --signid "Developer ID Application: MATTHEW STEVEN ERNST ($TEAM_ID)" \
          --customernumber "$PACE_CUSTOMER_NUMBER" \
          --customername "MBM Audio" \
          --productname "magic.RIDE" \
          --allowsigningservice \
          --dsig1-compat off \
          --in "$AAX_IN" \
          --out "$AAX_OUT"

        echo "=== Verifying signed AAX ==="
        "$WRAPTOOL" verify --verbose --in "$AAX_OUT"

        "$ILOKTOOL" cloud --close -v
        echo "macOS AAX successfully wrapped and verified"

    - name: Upload wrapped macOS AAX
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PLUGIN_NAME }}-${{ env.VERSION }}-macOS-AAX-Signed
        path: ${{ runner.temp }}/magic.RIDE.aaxplugin

    - name: Cleanup Keychain
      if: always()
      run: security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
