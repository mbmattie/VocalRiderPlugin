name: Extract PACE Tools

on:
  workflow_dispatch:

jobs:
  extract:
    runs-on: windows-latest
    steps:
    - name: Download Eden SDK
      env:
        GH_TOKEN: ${{ secrets.BUILD_TOOLS_TOKEN }}
      run: |
        New-Item -ItemType Directory -Path "$env:RUNNER_TEMP\eden" -Force | Out-Null

        # Try ZIP first (contains .iss response file), fall back to EXE
        $downloaded = $false
        try {
          gh release download eden-sdk-v5.10.4 --repo mbmattie/build-tools --pattern "*.zip" --dir "$env:RUNNER_TEMP\eden"
          $downloaded = (Get-ChildItem "$env:RUNNER_TEMP\eden" -Filter "*.zip" | Measure-Object).Count -gt 0
        } catch {}

        if (-not $downloaded) {
          gh release download eden-sdk-v5.10.4 --repo mbmattie/build-tools --pattern "*.exe" --dir "$env:RUNNER_TEMP\eden"
        }

        # If ZIP, extract it
        $zip = Get-ChildItem "$env:RUNNER_TEMP\eden" -Filter "*.zip" | Select-Object -First 1
        if ($zip) {
          Expand-Archive -Path $zip.FullName -DestinationPath "$env:RUNNER_TEMP\eden\extracted" -Force
        }

        Get-ChildItem "$env:RUNNER_TEMP\eden" -Recurse -Depth 2 | ForEach-Object {
          Write-Host "  $($_.FullName) ($([math]::Round($_.Length/1KB))KB)"
        }
      shell: pwsh

    - name: Install Eden SDK (PACE recommended method)
      run: |
        # Find installer exe
        $installer = Get-ChildItem "$env:RUNNER_TEMP\eden" -Filter "Eden*.exe" -Recurse | Select-Object -First 1
        if (-not $installer) {
          Write-Host "ERROR: No installer found"
          exit 1
        }
        Write-Host "Installer: $($installer.FullName)"

        # Find .iss response file
        $issFile = Get-ChildItem $installer.Directory -Filter "*.iss" | Where-Object { $_.Name -notlike "*Uninstall*" } | Select-Object -First 1

        # PACE docs: silent install hangs at the end (known issue, fix expected in Fusion 6.0)
        # The install is complete by the time it hangs. Use Start-Process + sleep + kill.
        $args = @('/S', '/v"/qn /L*V c:\msi_log.txt"')
        if ($issFile) {
          $args += "/f1`"$($issFile.FullName)`""
          Write-Host "Using response file: $($issFile.FullName)"
        }

        Write-Host "Starting installer with args: $args"
        $proc = Start-Process -FilePath $installer.FullName -ArgumentList $args -PassThru

        Write-Host "Waiting 90 seconds for install to complete..."
        Start-Sleep -Seconds 90

        if (-not $proc.HasExited) {
          Write-Host "Installer still running (expected - known PACE issue). Killing process."
          Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 5
        } else {
          Write-Host "Installer exited with code: $($proc.ExitCode)"
        }

        # Check MSI log for any useful info
        if (Test-Path "c:\msi_log.txt") {
          Write-Host "=== MSI Log (last 30 lines) ==="
          Get-Content "c:\msi_log.txt" -Tail 30
        }
      shell: pwsh

    - name: Verify installation
      run: |
        $toolsDir = "C:\Program Files (x86)\PACEAntiPiracy\Eden\Fusion\Versions\5"

        Write-Host "=== Checking expected install path ==="
        if (Test-Path $toolsDir) {
          Write-Host "FOUND: $toolsDir"
          Get-ChildItem $toolsDir -Recurse | ForEach-Object {
            Write-Host "  $($_.FullName) ($([math]::Round($_.Length/1KB))KB)"
          }
        } else {
          Write-Host "Expected path not found. Searching..."
          Get-ChildItem "C:\Program Files (x86)\PACEAntiPiracy" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  $($_.FullName)"
          }
          Get-ChildItem "C:\Program Files\PACEAntiPiracy" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  $($_.FullName)"
          }
        }

        Write-Host "=== Searching for wraptool.exe ==="
        $wraptool = Get-ChildItem "C:\Program Files (x86)","C:\Program Files" -Filter "wraptool.exe" -Recurse -ErrorAction SilentlyContinue
        foreach ($w in $wraptool) { Write-Host "FOUND: $($w.FullName)" }

        Write-Host "=== Searching for iloktool.exe ==="
        $iloktool = Get-ChildItem "C:\Program Files (x86)","C:\Program Files" -Filter "iloktool.exe" -Recurse -ErrorAction SilentlyContinue
        foreach ($i in $iloktool) { Write-Host "FOUND: $($i.FullName)" }

        Write-Host "=== Testing wraptool ==="
        if ($wraptool) {
          & $wraptool[0].FullName help 2>&1
        }
      shell: pwsh

    - name: Package PACE tools
      run: |
        $outDir = "$env:RUNNER_TEMP\pace-tools"
        New-Item -ItemType Directory -Path $outDir -Force | Out-Null

        # Collect from known install path and search
        $tools = @()
        $tools += Get-ChildItem "C:\Program Files (x86)","C:\Program Files" -Filter "wraptool.exe" -Recurse -ErrorAction SilentlyContinue
        $tools += Get-ChildItem "C:\Program Files (x86)","C:\Program Files" -Filter "iloktool.exe" -Recurse -ErrorAction SilentlyContinue

        foreach ($tool in ($tools | Sort-Object FullName -Unique)) {
          Write-Host "Packaging: $($tool.FullName)"
          Copy-Item $tool.FullName "$outDir\" -Force
          # Copy companion DLLs
          Get-ChildItem $tool.Directory -Filter "*.dll" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "$outDir\" -Force
            Write-Host "  + $($_.Name)"
          }
          # Copy the entire bin directory contents for completeness
          Get-ChildItem $tool.Directory -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "$outDir\" -Force -ErrorAction SilentlyContinue
          }
        }

        Write-Host "=== Package contents ==="
        Get-ChildItem $outDir | ForEach-Object {
          Write-Host "  $($_.Name) ($([math]::Round($_.Length/1KB))KB)"
        }
      shell: pwsh

    - name: Upload PACE tools
      uses: actions/upload-artifact@v4
      with:
        name: pace-tools-win64
        path: ${{ runner.temp }}/pace-tools/*
        if-no-files-found: warn
