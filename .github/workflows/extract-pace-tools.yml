name: Extract PACE Tools

on:
  workflow_dispatch:

jobs:
  extract:
    runs-on: windows-latest
    steps:
    - name: Download Eden SDK (ZIP version)
      env:
        GH_TOKEN: ${{ secrets.BUILD_TOOLS_TOKEN }}
      run: |
        Write-Host "Downloading Eden SDK ZIP..."
        New-Item -ItemType Directory -Path "$env:RUNNER_TEMP\eden" -Force | Out-Null

        # Try ZIP version first, fall back to EXE
        $downloaded = $false
        try {
          gh release download eden-sdk-v5.10.4 `
            --repo mbmattie/build-tools `
            --pattern "*.zip" `
            --dir "$env:RUNNER_TEMP\eden"
          $downloaded = (Get-ChildItem "$env:RUNNER_TEMP\eden" -Filter "*.zip" | Measure-Object).Count -gt 0
        } catch {}

        if (-not $downloaded) {
          Write-Host "No ZIP found, downloading EXE..."
          gh release download eden-sdk-v5.10.4 `
            --repo mbmattie/build-tools `
            --pattern "*.exe" `
            --dir "$env:RUNNER_TEMP\eden"
        }

        Get-ChildItem "$env:RUNNER_TEMP\eden" | ForEach-Object {
          Write-Host "Downloaded: $($_.Name) ($([math]::Round($_.Length/1MB))MB)"
        }
      shell: pwsh

    - name: Extract and install Eden SDK
      run: |
        $edenDir = "$env:RUNNER_TEMP\eden"
        $extractDir = "$env:RUNNER_TEMP\eden-install"

        # If ZIP, extract it first
        $zip = Get-ChildItem $edenDir -Filter "*.zip" | Select-Object -First 1
        if ($zip) {
          Write-Host "Extracting ZIP: $($zip.Name)"
          Expand-Archive -Path $zip.FullName -DestinationPath $extractDir -Force
          Get-ChildItem $extractDir -Recurse -Depth 2 | ForEach-Object {
            Write-Host "  $($_.FullName)"
          }
        }

        # Find the installer EXE (either from ZIP or direct download)
        $installer = Get-ChildItem $extractDir -Filter "*.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $installer) {
          $installer = Get-ChildItem $edenDir -Filter "*.exe" | Select-Object -First 1
        }

        if (-not $installer) {
          Write-Host "ERROR: No installer found."
          exit 1
        }

        Write-Host "Running installer: $($installer.FullName)"

        # Find .iss response file if available
        $issFile = Get-ChildItem $installer.Directory -Filter "*.iss" -ErrorAction SilentlyContinue | Where-Object { $_.Name -notlike "*Uninstall*" } | Select-Object -First 1

        if ($issFile) {
          Write-Host "Using response file: $($issFile.FullName)"
          $proc = Start-Process -FilePath $installer.FullName -ArgumentList "/s","/f1`"$($issFile.FullName)`"" -Wait -PassThru
        } else {
          Write-Host "No response file, trying silent install..."
          $proc = Start-Process -FilePath $installer.FullName -ArgumentList "/s",'/v"/qn ALLUSERS=1 REBOOT=ReallySuppress"' -Wait -PassThru
        }

        Write-Host "Installer exit code: $($proc.ExitCode)"
        Start-Sleep -Seconds 10
      shell: pwsh
      continue-on-error: true

    - name: Search for PACE tools
      run: |
        Write-Host "=== Searching Program Files ==="
        $wraptool = Get-ChildItem "C:\Program Files","C:\Program Files (x86)" -Filter "wraptool.exe" -Recurse -ErrorAction SilentlyContinue
        $iloktool = Get-ChildItem "C:\Program Files","C:\Program Files (x86)" -Filter "iloktool.exe" -Recurse -ErrorAction SilentlyContinue

        foreach ($w in $wraptool) { Write-Host "FOUND wraptool: $($w.FullName)" }
        foreach ($i in $iloktool) { Write-Host "FOUND iloktool: $($i.FullName)" }

        if (-not $wraptool) {
          Write-Host "Not in Program Files, searching PACE paths..."
          $searchPaths = @(
            "C:\PACEAntiPiracy",
            "C:\Program Files\PACE Anti-Piracy",
            "C:\Program Files (x86)\PACE Anti-Piracy",
            "C:\Program Files\Common Files\PACE",
            "$env:RUNNER_TEMP"
          )
          foreach ($sp in $searchPaths) {
            if (Test-Path $sp) {
              Write-Host "Contents of ${sp}:"
              Get-ChildItem $sp -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
                Write-Host "  $($_.FullName) ($($_.Length))"
              }
            }
          }

          Write-Host "=== Broad search for wraptool ==="
          Get-ChildItem "C:\" -Filter "wraptool.exe" -Recurse -ErrorAction SilentlyContinue -Depth 10 | ForEach-Object {
            Write-Host "FOUND: $($_.FullName)"
          }
        }
      shell: pwsh

    - name: Package PACE tools
      run: |
        $outDir = "$env:RUNNER_TEMP\pace-tools"
        New-Item -ItemType Directory -Path $outDir -Force | Out-Null

        $allTools = @()
        $allTools += Get-ChildItem "C:\Program Files","C:\Program Files (x86)","C:\" -Filter "wraptool.exe" -Recurse -ErrorAction SilentlyContinue -Depth 10
        $allTools += Get-ChildItem "C:\Program Files","C:\Program Files (x86)","C:\" -Filter "iloktool.exe" -Recurse -ErrorAction SilentlyContinue -Depth 10

        if ($allTools.Count -eq 0) {
          Write-Host "WARNING: No PACE tools found. Creating empty marker file."
          "No tools found" | Out-File "$outDir\NOT_FOUND.txt"
        }

        foreach ($tool in ($allTools | Sort-Object FullName -Unique)) {
          Write-Host "Packaging: $($tool.FullName)"
          Copy-Item $tool.FullName "$outDir\" -Force
          Get-ChildItem $tool.Directory -Filter "*.dll" -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName "$outDir\" -Force
            Write-Host "  + DLL: $($_.Name)"
          }
        }

        Write-Host "=== Package contents ==="
        Get-ChildItem $outDir | ForEach-Object {
          Write-Host "  $($_.Name) ($([math]::Round($_.Length/1KB))KB)"
        }
      shell: pwsh

    - name: Upload PACE tools
      uses: actions/upload-artifact@v4
      with:
        name: pace-tools-win64
        path: ${{ runner.temp }}/pace-tools/*
        if-no-files-found: warn
